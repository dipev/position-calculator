<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Position Size Auto-Calculator</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--accent2:#60a5fa;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,Arial;color:#e6eef6;background:linear-gradient(180deg,#051023 0%,#071329 100%);}
    .wrap{max-width:980px;margin:28px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 6px 30px rgba(2,6,23,0.6);} 
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=number], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--card);color:#e6eef6;font-size:14px}
    .controls{display:flex;gap:10px;align-items:center}
    button{background:var(--accent);color:#011526;border:0;padding:10px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .row-wide{grid-column:1 / -1}
    .result-card{margin-top:12px;padding:12px;border-radius:8px;background:var(--glass);display:flex;gap:12px;align-items:center}
    .stat{font-size:14px;color:#e6eef6}
    .muted{color:var(--muted);font-size:12px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Position Size Auto-Calculator — RSI 30 strategy</h1>
    <p class="lead">Enter your capital and L1 entry price. The calculator uses your allocation rules (5% per stock, 4 parts of 1.25% each) and averaging drops to produce share counts, costs, average price and the 6% TP.</p>

    <div class="grid">
      <div>
        <label>Total capital (₹)</label>
        <input id="totalCapital" type="number" value="0" min="1" step="1">
      </div>
      <div>
        <label>L1 Entry Price (₹)</label>
        <input id="entryPrice" type="number" value="200" min="0.0001" step="0.01">
      </div>

      <div>
        <label>Per-stock allocation (%)</label>
        <input id="perStockPct" type="number" value="5" step="0.1">
      </div>
      <div>
        <label>Parts (levels)</label>
        <select id="parts">
          <option value="4" selected>4 parts (L1..L4)</option>
          <option value="3">3 parts</option>
          <option value="2">2 parts</option>
        </select>
      </div>

      <div>
        <label>Drop L2 from L1 (%)</label>
        <input id="drop1" type="number" value="5" step="0.1">
      </div>
      <div>
        <label>Drop L3 from L2 (%)</label>
        <input id="drop2" type="number" value="5" step="0.1">
      </div>
      <div>
        <label>Drop L4 from L3 (%)</label>
        <input id="drop3" type="number" value="10" step="0.1">
      </div>
      <div>
        <label>Take profit (%)</label>
        <input id="tpPct" type="number" value="6" step="0.1">
      </div>

      <div class="row-wide">
        <div class="controls">
          <button id="calcBtn">Calculate</button>
          <button id="resetBtn" class="secondary">Reset</button>
          <button id="downloadCsv" class="secondary">Download CSV</button>
        </div>
      </div>

      <div class="row-wide">
        <div class="result-card">
          <div>
            <div class="muted">Per-stock allocation</div>
            <div id="perStockAlloc" class="stat">—</div>
          </div>
          <div>
            <div class="muted">Per-trade allocation</div>
            <div id="perTradeAlloc" class="stat">—</div>
          </div>
          <div>
            <div class="muted">Total shares (all levels)</div>
            <div id="totalShares" class="stat">—</div>
          </div>
          <div>
            <div class="muted">Total cost</div>
            <div id="totalCost" class="stat">—</div>
          </div>
          <div>
            <div class="muted">Avg cost / share</div>
            <div id="avgCost" class="stat">—</div>
          </div>
        </div>
      </div>

      <div class="row-wide">
        <table id="outTable">
          <thead>
            <tr>
              <th>Level</th>
              <th>Price (₹)</th>
              <th>Alloc (₹)</th>
              <th>Shares</th>
              <th>Cost (₹)</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <div class="row-wide">
        <div class="muted">Target (avg cost × TP%)</div>
        <div class="stat" id="tpLine">—</div>
        <div class="note">Note: shares are floored to whole units; leftover cash per-trade will remain in your account.</div>
      </div>

    </div>

    <footer>Local HTML file — open in your browser. No data leaves your device.</footer>
  </div>

<script>
function format(n){ return (Math.round((n+Number.EPSILON)*100)/100).toLocaleString('en-IN'); }
function calc(){
  const total = parseFloat(document.getElementById('totalCapital').value)||0;
  const entry = parseFloat(document.getElementById('entryPrice').value)||0;
  const perStockPct = parseFloat(document.getElementById('perStockPct').value)/100 || 0.05;
  const parts = parseInt(document.getElementById('parts').value,10)||4;
  const d1 = (parseFloat(document.getElementById('drop1').value)||5)/100;
  const d2 = (parseFloat(document.getElementById('drop2').value)||5)/100;
  const d3 = (parseFloat(document.getElementById('drop3').value)||10)/100;
  const tpPct = (parseFloat(document.getElementById('tpPct').value)||6)/100;

  const perStock = total * perStockPct;
  const perTrade = total * (perStockPct / parts);

  // calculate prices per level
  const p1 = entry;
  const p2 = p1 * (1 - d1);
  const p3 = p2 * (1 - d2);
  const p4 = p3 * (1 - d3);
  const prices = [p1,p2,p3,p4].slice(0, parts);

  const rows = [];
  let totalShares = 0;
  let totalCost = 0;
  for(let i=0;i<prices.length;i++){
    const p = prices[i];
    const shares = Math.floor(perTrade / p);
    const cost = shares * p;
    rows.push({level: 'L'+(i+1), price:p, alloc:perTrade, shares:shares, cost:cost});
    totalShares += shares;
    totalCost += cost;
  }

  const avgCost = totalShares>0? totalCost/totalShares : 0;
  const tpPrice = avgCost * (1 + tpPct);
  const tpValue = tpPrice * totalShares;
  const profit = tpValue - totalCost;
  const profitPct = totalCost>0? (profit/totalCost)*100 : 0;

  // render
  document.getElementById('perStockAlloc').textContent = '₹ ' + format(perStock);
  document.getElementById('perTradeAlloc').textContent = '₹ ' + format(perTrade);
  document.getElementById('totalShares').textContent = format(totalShares);
  document.getElementById('totalCost').textContent = '₹ ' + format(totalCost);
  document.getElementById('avgCost').textContent = '₹ ' + format(avgCost);

  const tbody = document.querySelector('#outTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.level}</td><td>₹ ${format(r.price)}</td><td>₹ ${format(r.alloc)}</td><td>${r.shares}</td><td>₹ ${format(r.cost)}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('tpLine').textContent = `TP price: ₹ ${format(tpPrice)}  |  TP value: ₹ ${format(tpValue)}  |  Profit: ₹ ${format(profit)} (${format(profitPct)}%)`;

  // store last result for CSV
  window._lastCalc = {rows, perStock, perTrade, totalShares, totalCost, avgCost, tpPrice, tpValue, profit, profitPct};
}

function downloadCSV(){
  const d = window._lastCalc;
  if(!d){ alert('Run calculation first'); return; }
  let csv = 'Level,Price,Alloc,Shares,Cost\n';
  d.rows.forEach(r=> csv += `${r.level},${r.price},${r.alloc},${r.shares},${r.cost}\n`);
  csv += `, , , ,\nTotalShares,${d.totalShares}\nTotalCost,${d.totalCost}\nAvgCost,${d.avgCost}\nTPprice,${d.tpPrice}\nTPvalue,${d.tpValue}\nProfit,${d.profit}\nProfitPct,${d.profitPct}`;
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'position_size_calc.csv'; a.click(); URL.revokeObjectURL(url);
}

document.getElementById('calcBtn').addEventListener('click', calc);
document.getElementById('resetBtn').addEventListener('click', ()=>{document.getElementById('totalCapital').value='704653';document.getElementById('entryPrice').value='200';document.getElementById('drop1').value='5';document.getElementById('drop2').value='5';document.getElementById('drop3').value='10';document.getElementById('perStockPct').value='5';document.getElementById('tpPct').value='6';calc();});
document.getElementById('downloadCsv').addEventListener('click', downloadCSV);

// initial calc
calc();
</script>
</body>
</html>
